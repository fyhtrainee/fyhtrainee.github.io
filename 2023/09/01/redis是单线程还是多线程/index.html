<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><link rel="alternate" href="/rss.xml" title="yuHeng's blog" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="yuHeng's blog" type="application/atom+xml"><link rel="alternate" type="application/json" title="yuHeng's blog" href="http://example.com/feed.json"/><link rel="preconnect" href="https://lf9-cdn-tos.bytecdntp.com"/><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"/><link rel="dns-prefetch" href="https://unpkg.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.3.5"><script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.js"></script><link rel="canonical" href="http://example.com/2023/09/01/redis%E6%98%AF%E5%8D%95%E7%BA%BF%E7%A8%8B%E8%BF%98%E6%98%AF%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><title>redis是单线程还是多线程</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">redis是单线程还是多线程</h1><div class="meta"><span class="item" title="创建时间：2023-09-01 16:12:51"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2023-09-01T16:12:51+08:00">2023-09-01</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>2.8k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>3 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">妙妙屋</a></li></ul><ul class="right" id="rightNav"><li class="item theme" @click="changeThemeByBtn"><i class="ic" :class="{'i-sun': !themeStatus,'i-moon': themeStatus}"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" data-background-image="https://img1.imgtp.com/2023/08/24/eRUUr1A7.jpg"></li><li class="item" data-background-image="https://img1.imgtp.com/2023/08/24/71NMZo7P.gif"></li><li class="item" data-background-image="https://img1.imgtp.com/2023/08/24/S4lCRtrb.gif"></li><li class="item" data-background-image="https://img1.imgtp.com/2023/08/24/7CtMMWud.jpg"></li><li class="item" data-background-image="https://img1.imgtp.com/2023/08/24/KNxhEv4w.gif"></li><li class="item" data-background-image="https://img1.imgtp.com/2023/08/24/b6tPpPQU.gif"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2023/09/01/redis%E6%98%AF%E5%8D%95%E7%BA%BF%E7%A8%8B%E8%BF%98%E6%98%AF%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"/><meta itemprop="name" content="yuHeng"/><meta itemprop="description" content=", "/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="yuHeng's blog"/></span><div class="body md" itemprop="articleBody"><h1 id="redis是单线程还是多线程的"><a class="markdownIt-Anchor" href="#redis是单线程还是多线程的">#</a> Redis 是单线程还是多线程的？</h1>
<h2 id="1官网解释"><a class="markdownIt-Anchor" href="#1官网解释">#</a> 1. 官网解释</h2>
<h3 id="how-can-redis-use-multiple-cpus-or-cores"><a class="markdownIt-Anchor" href="#how-can-redis-use-multiple-cpus-or-cores">#</a> How can Redis use multiple CPUs or cores?</h3>
<p>It’s not very frequent that CPU becomes your bottleneck with Redis, as usually Redis is either memory or network bound. For instance, when using pipelining a Redis instance running on an average Linux system can deliver 1 million requests per second, so if your application mainly uses O(N) or O(log(N)) commands, it is hardly going to use too much CPU.</p>
<p>However, to maximize CPU usage you can start multiple instances of Redis in the same box and treat them as different servers. At some point a single box may not be enough anyway, so if you want to use multiple CPUs you can start thinking of some way to shard earlier.</p>
<p>You can find more information about using multiple Redis instances in the <span class="exturl" data-url="aHR0cHM6Ly9yZWRpcy5pby90b3BpY3MvcGFydGl0aW9uaW5n">Partitioning page</span>.</p>
<p>As of version 4.0, Redis has started implementing threaded actions. For now this is limited to deleting objects in the background and blocking commands implemented via Redis modules. For subsequent releases, the plan is to make Redis more and more threaded.</p>
<blockquote>
<p>CPU 成为 Redis 瓶颈的情况并不常见，因为 Redis 通常都是内存或网络绑定的。例如，当使用流水线时，在普通 Linux 系统上运行的 Redis 实例每秒可提供 100 万个请求，所以如果你的应用程序主要使用 O (N) 或 O (log (N)) 命令，几乎不会占用太多 CPU。</p>
<p>不过，为了最大限度地提高 CPU 使用率，你可以在同一个盒子中启动多个 Redis 实例，并将它们视为不同的服务器。在某些情况下，一个盒子可能不够用，所以如果你想使用多个 CPU，可以考虑提前分片。</p>
<p>有关使用多个 Redis 实例的更多信息，请参阅分区页面。</p>
<p>从 4.0 版开始，Redis 开始实现线程操作。目前，这仅限于在后台删除对象和通过 Redis 模块执行阻塞命令。在后续版本中，我们计划让 Redis 的线程化程度越来越高。</p>
</blockquote>
<h2 id="2-redis40之前"><a class="markdownIt-Anchor" href="#2-redis40之前">#</a> 2. Redis4.0 之前</h2>
<p>在 redis4.x 时代，redis 的任何操作都是单线程的，而单线程的 redis 具有以下几个优点。</p>
<ol>
<li>单线程模型使得 redis 的开发和维护更加简单。</li>
<li>即使使用的是单线程模型，也可以并发地处理多客户端的请求，主要使用的是 IO 多路复用和非阻塞 IO 实现。</li>
<li>对于 Redis 系统来说，<em><strong>主要的性能瓶颈是内存或者网络带宽而非 CPU</strong></em>。</li>
</ol>
<p>单线程引发的问题：</p>
<ol>
<li>正常情况下，del 命令可以很快地删除数据，但是当被删除的数据是一个非常大的对象时，例如包含了成千上万个元素的 hash 集合，那么 del 指令就会造成 Redis 主线程卡顿。</li>
</ol>
<p>解决方案：惰性删除（lazy del）</p>
<ol>
<li>使用 unlink 命令可以实现数据的异步删除的功能，然是处理其读写请求的仍然只有一个线程，所以仍然算是狭义上的单线程。</li>
</ol>
<h2 id="3-redis67"><a class="markdownIt-Anchor" href="#3-redis67">#</a> 3. Redis6/7</h2>
<p>从 redis6/7 开始，redis 正式引入多线程特性和 IO 多路复用。</p>
<p>官网中所说，<em><strong>redis 的性能瓶颈几乎不会是 cpu 的性能，而是内存或者网络带宽</strong></em>，所以为了提高吞吐量，采用多个 IO 线程来处理网络请求，提高网络请求处理的并行度，Redis6/7 就是采用的这种方法。</p>
<h4 id="主线程和io线程是怎么协作完成请求处理的"><a class="markdownIt-Anchor" href="#主线程和io线程是怎么协作完成请求处理的">#</a> 主线程和 IO 线程是怎么协作完成请求处理的？</h4>
<p>I/O 的读和写本身是堵塞的，比如当 socket 中有数据时，Redis 会通过调用先将数据从内核态空间拷贝到用户态空间，再交给 Redis 调用，而这个拷贝的过程就是阻塞的，当数据量越大时拷贝所需要的时间就越多，而这些操作都是基于单线程完成的。</p>
<div align=center><img data-src="https://img1.imgtp.com/2023/08/29/kuJvq97N.png"></div>
<p>从 Redis6 开始，就新增了多线程的功能来提高 I/O 的读写性能，他的主要实现思路是将主线程的 IO 读写任务拆分给一组独立的线程去执行，这样就可以使多个 socket 的读写可以并行化了，采用多路 I/O 复用技术可以让单个线程高效的处理多个连接请求（尽量减少网络 IO 的时间消耗），将最耗时的 Socket 的读取、请求解析、写入单独外包出去，剩下的命令执行仍然由主线程串行执行并和内存的数据交互。</p>
<p><img data-src="https://img1.imgtp.com/2023/08/29/Bky7gENR.png" alt="Redis6/7之前"></p>
<h4 id="多线程模式是否是默认开启的呢"><a class="markdownIt-Anchor" href="#多线程模式是否是默认开启的呢">#</a> 多线程模式是否是默认开启的呢？</h4>
<p>Redis6/7 并不默认开启多线程模式，需要手动开启。</p>
<p><img data-src="https://img1.imgtp.com/2023/08/29/UFnehp5j.png" alt="配置文件截图"></p>
<p>Redis 自身出道就是优秀，基于内存操作、数据结构简单、多路复用和非阻塞 I/O、避免了不必要的线程上下文切换等特性，在单线程的环境下依然很快；</p>
<p>但对于大数据的 key 删除还是卡顿厉害，因此在 Redis 4.0 引入了多线程 unlink key/flushall async 等命令，主要用于 Redis 数据的异步删除；</p>
<p>无论它如何变化，命令的执行依旧是由主线程串行执行的，因此，即使在多线程下操作 Redis 也不会出现线程安全问题。</p>
</div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2023-09-01 16:13:39" itemprop="dateModified" datetime="2023-09-01T16:13:39+08:00">2023-09-01</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/assets/wechatpay.png" alt="yuHeng 微信支付"/><p>微信支付</p></div><div><img data-src="/assets/alipay.png" alt="yuHeng 支付宝"/><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>yuHeng<i class="ic i-at"><em>@</em></i>yuHeng's blog</li><li class="link"><strong>本文链接：</strong><a href="http://example.com/2023/09/01/redis%E6%98%AF%E5%8D%95%E7%BA%BF%E7%A8%8B%E8%BF%98%E6%98%AF%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="redis是单线程还是多线程">http://example.com/2023/09/01/redis是单线程还是多线程/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"></div><div class="item right"><a href="/2023/09/01/redis-BigKey%E9%97%AE%E9%A2%98/" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;img1.imgtp.com&#x2F;2023&#x2F;08&#x2F;24&#x2F;7CtMMWud.jpg" title="redis BigKey问题"><span class="type">下一篇</span><h3>redis BigKey问题</h3></a></div></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#redis%E6%98%AF%E5%8D%95%E7%BA%BF%E7%A8%8B%E8%BF%98%E6%98%AF%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84"><span class="toc-number">1.</span> <span class="toc-text"> Redis 是单线程还是多线程的？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E5%AE%98%E7%BD%91%E8%A7%A3%E9%87%8A"><span class="toc-number">1.1.</span> <span class="toc-text"> 1. 官网解释</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#how-can-redis-use-multiple-cpus-or-cores"><span class="toc-number">1.1.1.</span> <span class="toc-text"> How can Redis use multiple CPUs or cores?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-redis40%E4%B9%8B%E5%89%8D"><span class="toc-number">1.2.</span> <span class="toc-text"> 2. Redis4.0 之前</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-redis67"><span class="toc-number">1.3.</span> <span class="toc-text"> 3. Redis6&#x2F;7</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E7%BA%BF%E7%A8%8B%E5%92%8Cio%E7%BA%BF%E7%A8%8B%E6%98%AF%E6%80%8E%E4%B9%88%E5%8D%8F%E4%BD%9C%E5%AE%8C%E6%88%90%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E7%9A%84"><span class="toc-number">1.3.0.1.</span> <span class="toc-text"> 主线程和 IO 线程是怎么协作完成请求处理的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%BC%8F%E6%98%AF%E5%90%A6%E6%98%AF%E9%BB%98%E8%AE%A4%E5%BC%80%E5%90%AF%E7%9A%84%E5%91%A2"><span class="toc-number">1.3.0.2.</span> <span class="toc-text"> 多线程模式是否是默认开启的呢？</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="yuHeng" data-src="/assets/avatar.jpg"/><p class="name" itemprop="name">yuHeng</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">2</span><span class="name">文章</span></a></div></nav><div class="social"><a href="https://github.com/name" class="item github" rel="noopener" title="https:&#x2F;&#x2F;github.com&#x2F;name" target="_blank"><i class="ic i-github"></i></a><a href="mailto:fyh2001it@163.com" class="item email" rel="noopener" title="mailto:fyh2001it@163.com" target="_blank"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-user"></i>关于</a><ul class="submenu"><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于本站</a></li><li class="item"><a href="/admiration/" rel="section"><i class="ic i-coffee"></i>赞赏博主</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2023/09/01/redis-BigKey%E9%97%AE%E9%A2%98/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/2023/09/01/redis%E6%98%AF%E5%8D%95%E7%BA%BF%E7%A8%8B%E8%BF%98%E6%98%AF%E5%A4%9A%E7%BA%BF%E7%A8%8B/">redis是单线程还是多线程</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2023/09/01/redis-BigKey%E9%97%AE%E9%A2%98/">redis BigKey问题</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2023</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">yuHeng @ 妙妙屋</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">3k 字</span><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">3 分钟</span></div><div class="powered-by">基于 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & Theme.<a href="https://github.com/theme-shoka-x/hexo-theme-shokaX/" rel="noopener" target="_blank">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
        path: `2023/09/01/redis是单线程还是多线程/`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,
    chart: false,
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=default,fetch"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.0.2/pace.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/algoliasearch/4.12.1/algoliasearch-lite.umd.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/instantsearch.js/4.39.0/instantsearch.production.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/quicklink/2.2.0/quicklink.umd.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/??jquery/3.5.1/jquery.min.js,fancybox/3.5.7/jquery.fancybox.min.js,justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" async></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/KaTeX/0.15.2/contrib/copy-tex.min.js" async></script><script src="/js/app.js?v=0.3.5"></script></body></html>